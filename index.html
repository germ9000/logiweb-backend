<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiTrack ERP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 500: '#1a73e8', 600: '#1557b0' } }
                }
            }
        }
    </script>
    <style>
        .glass-panel { background: white; border: 1px solid #E5E7EB; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        /* Ocultar elementos baseados em role */
        body.role-comum .admin-only { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-brand-500 text-white p-2 rounded-lg"><i class="fa-solid fa-box-open"></i></div>
            <span class="font-bold text-xl text-slate-900">LogiTrack ERP</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex space-x-1 bg-slate-100 p-1 rounded-lg">
                <button onclick="nav('dashboard')" class="admin-only px-3 py-1.5 text-sm font-medium rounded-md hover:bg-white hover:shadow-sm transition">Dashboard</button>
                <button onclick="nav('estoque')" class="px-3 py-1.5 text-sm font-medium rounded-md bg-white shadow-sm text-brand-600">Estoque</button>
                <button onclick="nav('saida')" class="px-3 py-1.5 text-sm font-medium rounded-md hover:bg-white hover:shadow-sm transition">Saídas</button>
                <button onclick="nav('entrada')" class="px-3 py-1.5 text-sm font-medium rounded-md hover:bg-white hover:shadow-sm transition">Entradas</button>
                <button onclick="nav('importar')" class="px-3 py-1.5 text-sm font-medium rounded-md hover:bg-white hover:shadow-sm transition">Importar Excel</button>
                <button onclick="nav('usuarios')" class="admin-only px-3 py-1.5 text-sm font-medium rounded-md hover:bg-white hover:shadow-sm transition">Usuários</button>
            </div>
            
            <div class="flex items-center gap-3 border-l pl-4 ml-2">
                <div class="text-right hidden sm:block">
                    <p id="user-name" class="text-sm font-bold text-slate-900">Visitante</p>
                    <p id="user-role" class="text-xs text-slate-500 uppercase">--</p>
                </div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 overflow-auto p-4 sm:p-6 relative">
        
        <section id="view-dashboard" class="hidden h-full flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Analytics Avançado</h2>
            <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative">
                <iframe 
                    src="https://lookerstudio.google.com/embed/reporting/SEU_ID_DO_LOOKER_AQUI/page/SEU_ID_DA_PAGINA" 
                    frameborder="0" style="border:0" allowfullscreen class="w-full h-full absolute inset-0">
                </iframe>
                <div class="absolute inset-0 flex items-center justify-center bg-slate-50 -z-10">
                    <p>Carregando Dashboard...</p>
                </div>
            </div>
        </section>

        <section id="view-estoque" class="hidden">
            <div class="flex justify-between mb-4">
                <h2 class="text-2xl font-bold">Visão Geral do Estoque</h2>
                <button onclick="fetchItems()" class="text-brand-600"><i class="fa-solid fa-sync"></i> Atualizar</button>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                        <tr><th class="p-4">ID</th><th class="p-4">Produto</th><th class="p-4">Qtd</th><th class="p-4">Local</th></tr>
                    </thead>
                    <tbody id="estoque-body" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </section>

        <section id="view-saida" class="hidden max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-2">Registrar Saída</h2>
            <p class="text-slate-500 mb-6">Baixa de estoque e registro de consumo.</p>
            
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Buscar Item</label>
                    <select id="saida-select" class="w-full border rounded p-2 bg-slate-50" onchange="checkStockInfo()">
                        <option value="">Selecione um item...</option>
                        </select>
                </div>
                
                <div id="stock-info" class="mb-4 p-3 bg-blue-50 text-blue-800 rounded hidden">
                    Estoque Atual: <span id="current-stock" class="font-bold">0</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Quantidade de Saída</label>
                        <input type="number" id="saida-qtd" class="w-full border rounded p-2" min="1">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Destino/Motivo</label>
                        <input type="text" id="saida-motivo" class="w-full border rounded p-2" placeholder="Ex: Consumo Interno">
                    </div>
                </div>

                <button onclick="registrarSaida()" class="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700">
                    Confirmar Saída
                </button>
            </div>
        </section>

        <section id="view-entrada" class="hidden max-w-2xl mx-auto">
             <h2 class="text-2xl font-bold mb-6">Nova Entrada</h2>
             <div class="bg-white p-6 rounded-xl border border-slate-200">
                 <input type="text" id="in-id" placeholder="ID/SKU" class="w-full border p-2 mb-2 rounded">
                 <input type="text" id="in-nome" placeholder="Nome" class="w-full border p-2 mb-2 rounded">
                 <input type="number" id="in-qtd" placeholder="Qtd" class="w-full border p-2 mb-2 rounded">
                 <button onclick="registrarEntrada()" class="w-full bg-brand-500 text-white py-2 rounded font-bold">Salvar Entrada</button>
             </div>
        </section>

        <section id="view-importar" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Importação em Lote e Conferência</h2>
            
            <div class="bg-white p-8 rounded-xl border-2 border-dashed border-slate-300 text-center mb-6" id="drop-area">
                <i class="fa-solid fa-file-excel text-4xl text-green-600 mb-2"></i>
                <p>Arraste sua planilha .xlsx ou clique para selecionar</p>
                <input type="file" id="excel-file" accept=".xlsx, .xls" class="hidden" onchange="handleFile(this.files[0])">
                <button onclick="document.getElementById('excel-file').click()" class="mt-4 px-4 py-2 bg-slate-100 rounded hover:bg-slate-200">Selecionar Arquivo</button>
            </div>

            <div id="conferencia-area" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold">Itens Identificados: <span id="count-total">0</span></h3>
                    <button onclick="processarImportacao()" class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">
                        Confirmar Importação dos Itens Marcados
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 w-10"><input type="checkbox" onchange="toggleAll(this)"></th>
                                <th class="p-3">Status</th>
                                <th class="p-3">ID</th>
                                <th class="p-3">Produto</th>
                                <th class="p-3">Qtd Prevista</th>
                            </tr>
                        </thead>
                        <tbody id="excel-list"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-usuarios" class="hidden max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Gerenciar Usuários</h2>
                <button onclick="document.getElementById('modal-user').classList.remove('hidden')" class="bg-brand-500 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Novo Usuário</button>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-4">Nome</th><th class="p-4">Email</th><th class="p-4">Papel</th></tr>
                    </thead>
                    <tbody id="users-body"></tbody>
                </table>
            </div>
        </section>

    </main>

    <div id="modal-user" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-96 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Novo Usuário</h3>
            <input type="text" id="new-user-name" placeholder="Nome" class="w-full border p-2 mb-3 rounded">
            <input type="email" id="new-user-email" placeholder="Email" class="w-full border p-2 mb-3 rounded">
            <input type="password" id="new-user-pass" placeholder="Senha" class="w-full border p-2 mb-3 rounded">
            <select id="new-user-role" class="w-full border p-2 mb-4 rounded bg-white">
                <option value="comum">Comum</option>
                <option value="admin">Administrador</option>
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modal-user').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancelar</button>
                <button onclick="criarUsuario()" class="px-4 py-2 bg-brand-500 text-white rounded">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GERENCIAMENTO DE ESTADO E NAVEGAÇÃO ---
        const STATE = {
            user: JSON.parse(localStorage.getItem('logiUser')) || null, // { nome, role, email }
            items: [],
            importedItems: []
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            if(!STATE.user) {
                // Se não logado, mandar pro login (aqui vou simular que já logou para demo)
                // window.location.href = 'login.html';
                // Para teste imediato, vamos criar um user fake se não existir
                STATE.user = { nome: "Admin Demo", role: "admin" }; 
            }
            updateUIProfile();
            nav('estoque');
        });

        function updateUIProfile() {
            document.getElementById('user-name').innerText = STATE.user.nome;
            document.getElementById('user-role').innerText = STATE.user.role;
            document.body.className = `role-${STATE.user.role}`; // Ajuda o CSS a esconder coisas
        }

        function nav(viewId) {
            // Esconde todas as seções
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            
            // Segurança simples de front: Se for admin-only e user for comum, bloqueia
            if (['dashboard', 'usuarios'].includes(viewId) && STATE.user.role !== 'admin') {
                alert("Acesso restrito a administradores.");
                return;
            }

            // Mostra a desejada
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            // Carrega dados específicos se necessário
            if(viewId === 'estoque' || viewId === 'saida') fetchItems();
            if(viewId === 'usuarios') fetchUsers();
        }

        function logout() {
            localStorage.removeItem('logiUser');
            window.location.reload();
        }

        // --- 2. API INTEGRATION (Itens) ---
        async function fetchItems() {
            // Simulação de Fetch (Substitua pela URL real /api/items)
            try {
                const res = await fetch('/api/items');
                const data = await res.json();
                
                // Mapear dados da planilha (Array) para Objetos
                // Ajuste os índices conforme sua planilha: [id, nome, cat, qtd, local...]
                STATE.items = data.map(r => ({ id: r[0], name: r[1], qty: parseInt(r[3]), local: r[4] }));
                
                renderEstoque();
                populateSelectSaida();
            } catch (e) { console.error("Erro fetch", e); }
        }

        function renderEstoque() {
            const tbody = document.getElementById('estoque-body');
            tbody.innerHTML = STATE.items.map(i => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-mono text-xs font-bold">${i.id}</td>
                    <td class="p-4 font-bold">${i.name}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">${i.qty}</span></td>
                    <td class="p-4 text-slate-500">${i.local || '-'}</td>
                </tr>
            `).join('');
        }

        // --- 3. LÓGICA DE SAÍDA ---
        function populateSelectSaida() {
            const select = document.getElementById('saida-select');
            select.innerHTML = '<option value="">Selecione um item...</option>' + 
                STATE.items.map(i => `<option value="${i.id}">${i.name} (Saldo: ${i.qty})</option>`).join('');
        }

        function checkStockInfo() {
            const id = document.getElementById('saida-select').value;
            const item = STATE.items.find(i => i.id === id);
            const infoDiv = document.getElementById('stock-info');
            
            if(item) {
                infoDiv.classList.remove('hidden');
                document.getElementById('current-stock').innerText = item.qty;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        async function registrarSaida() {
            const id = document.getElementById('saida-select').value;
            const qtd = document.getElementById('saida-qtd').value;
            const motivo = document.getElementById('saida-motivo').value;

            if(!id || !qtd) return alert("Preencha os campos obrigatórios");
            
            // Validar frontend
            const item = STATE.items.find(i => i.id === id);
            if(parseInt(qtd) > item.qty) return alert("Erro: Quantidade de saída maior que estoque atual.");

            // Enviar para API
            try {
                const res = await fetch('/api/items', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'saida', id, quantidade: qtd, motivo })
                });
                if(res.ok) {
                    alert("Saída registrada!");
                    document.getElementById('saida-select').value = "";
                    document.getElementById('saida-qtd').value = "";
                    fetchItems(); // Recarrega
                } else {
                    const err = await res.json();
                    alert("Erro: " + err.error);
                }
            } catch (e) { alert("Erro de rede"); }
        }

        // --- 4. IMPORTAÇÃO EXCEL (SheetJS) ---
        function handleFile(file) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); // Header: 1 gera array de arrays

                // Remove cabeçalho e mapeia
                // Assumindo que o Excel vem colunas: [ID, Nome, Categoria, Quantidade, Local]
                STATE.importedItems = jsonData.slice(1).map((row, idx) => ({
                    uuid: idx, // ID temporario para a lista
                    checked: true, // Marcado por padrão
                    id: row[0],
                    name: row[1],
                    category: row[2],
                    qty: row[3],
                    local: row[4],
                    status: 'pendente'
                })).filter(i => i.id); // Remove linhas vazias

                renderImportList();
                document.getElementById('conferencia-area').classList.remove('hidden');
                document.getElementById('drop-area').classList.add('hidden');
            };
            reader.readAsArrayBuffer(file);
        }

        function renderImportList() {
            document.getElementById('count-total').innerText = STATE.importedItems.length;
            const tbody = document.getElementById('excel-list');
            tbody.innerHTML = STATE.importedItems.map(item => `
                <tr class="${item.checked ? 'bg-white' : 'bg-red-50 opacity-50'} border-b">
                    <td class="p-3"><input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItem(${item.uuid})"></td>
                    <td class="p-3"><span class="text-xs font-bold ${item.checked ? 'text-green-600' : 'text-red-500'}">${item.checked ? 'OK' : 'Faltante'}</span></td>
                    <td class="p-3 font-mono text-xs">${item.id}</td>
                    <td class="p-3">${item.name}</td>
                    <td class="p-3 font-bold">${item.qty}</td>
                </tr>
            `).join('');
        }

        function toggleItem(uuid) {
            const item = STATE.importedItems.find(i => i.uuid === uuid);
            item.checked = !item.checked;
            renderImportList();
        }

        async function processarImportacao() {
            const aprovados = STATE.importedItems.filter(i => i.checked);
            if(aprovados.length === 0) return alert("Nenhum item selecionado para importação.");

            if(!confirm(`Confirmar entrada de ${aprovados.length} itens no estoque?`)) return;

            // Enviar em lote (Ou um por um se sua API for simples)
            // Aqui faremos um loop simples para o exemplo, mas ideal é Batch API
            let sucesso = 0;
            for (const item of aprovados) {
                try {
                    await fetch('/api/items', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: item.id, nome: item.name, categoria: item.category, 
                            quantidade: item.quantidade, local: item.local
                        })
                    });
                    sucesso++;
                } catch(e) { console.error(e); }
            }
            alert(`Processo finalizado. ${sucesso} itens importados.`);
            nav('estoque');
        }

        // --- 5. USUÁRIOS (Admin) ---
        async function fetchUsers() {
            const res = await fetch('/api/users');
            const users = await res.json();
            document.getElementById('users-body').innerHTML = users.map(u => `
                <tr class="border-b">
                    <td class="p-4 font-bold">${u.nome}</td>
                    <td class="p-4 text-slate-500">${u.email}</td>
                    <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs uppercase">${u.role}</span></td>
                </tr>
            `).join('');
        }

        async function criarUsuario() {
            const nome = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const senha = document.getElementById('new-user-pass').value;
            const role = document.getElementById('new-user-role').value;

            const res = await fetch('/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nome, email, senha, role })
            });

            if(res.ok) {
                alert("Usuário criado!");
                document.getElementById('modal-user').classList.add('hidden');
                fetchUsers();
            }
        }
    </script>
</body>
</html>
