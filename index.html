<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventário Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
  <script>
        // --- CONFIGURAÇÃO DA API VERCEL ---
        const API_URL = '/api/items'; 

        let inventory = [];
        let html5QrcodeScanner = null;

        // Inicializa a aplicação carregando do Backend
        document.addEventListener('DOMContentLoaded', () => {
            fetchItems();
        });

        // --- 1. COMUNICAÇÃO COM O BACKEND (API/SHEETS) ---

        async function fetchItems() {
            const loadingState = document.getElementById('emptyState');
            // Feedback de carregamento
            loadingState.innerHTML = '<div class="flex flex-col items-center gap-2"><i class="fa-solid fa-spinner fa-spin text-2xl text-brand-600"></i><p class="text-slate-500">Sincronizando com a planilha...</p></div>';
            loadingState.classList.remove('hidden');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Falha ao buscar dados');
                
                const rows = await response.json();

                // ADAPTADOR: Transforma Array do Sheets em Objeto do Frontend
                // Baseado no seu api/items.js: [id, nome, categoria, quantidade, local, status, previsao]
                inventory = rows.map(row => ({
                    id: row[0],
                    name: row[1],
                    category: row[2],
                    qty: row[3],
                    code: row[4], // Usaremos o campo 'local' da planilha para guardar o CÓDIGO/SKU
                    // status: row[5], // Campos extras que não aparecem no card mas existem no banco
                    updatedAt: new Date().toISOString() // A planilha não tem data de update, geramos uma fake visual
                }));

                renderItems();

            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao carregar dados. Verifique se a API está rodando.");
                loadingState.innerHTML = '<p class="text-red-500">Erro de conexão.</p>';
            }
        }

        async function saveToBackend(newItem) {
            // Prepara o objeto no formato que seu api/items.js (POST) espera
            const payload = {
                id: newItem.id,
                nome: newItem.name,
                categoria: newItem.category,
                quantidade: newItem.qty,
                local: newItem.code, // Enviando o SKU para o campo 'local'
                status: 'Ativo',     // Valor padrão
                previsao: '-'        // Valor padrão
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Erro ao salvar');
                
                // Sucesso: Recarrega a lista para garantir sincronia
                // Otimização: Adiciona localmente para feedback instantâneo e depois busca
                inventory.unshift(newItem); 
                renderItems();
                
            } catch (error) {
                alert("Erro ao salvar na planilha: " + error.message);
            }
        }

        // --- 2. RENDERIZAÇÃO (Visual - Mantido igual) ---
        function renderItems() {
            const grid = document.getElementById('inventoryGrid');
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const emptyState = document.getElementById('emptyState');
            const totalLabel = document.getElementById('totalItems');

            grid.innerHTML = '';

            const filtered = inventory.filter(item => 
                (item.name && item.name.toLowerCase().includes(searchInput)) || 
                (item.code && item.code.toLowerCase().includes(searchInput))
            );

            totalLabel.innerText = filtered.length;

            if (filtered.length === 0) {
                // Se não estiver carregando (spinner), mostra msg de vazio
                if (!emptyState.innerHTML.includes('fa-spinner')) {
                    emptyState.innerHTML = `
                        <div class="bg-slate-100 p-6 rounded-full mb-4"><i class="fa-solid fa-clipboard-list text-4xl text-slate-300"></i></div>
                        <h3 class="text-lg font-medium text-slate-900">Nenhum item encontrado</h3>
                        <p class="text-slate-500 mt-1 mb-4">Seu inventário está vazio ou a busca não retornou resultados.</p>
                        <button onclick="openModal()" class="text-brand-600 font-medium hover:underline">Adicionar item</button>
                    `;
                    emptyState.classList.remove('hidden');
                    emptyState.classList.add('flex');
                }
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                
                filtered.forEach(item => {
                    let qtyColor = item.qty > 5 ? 'bg-emerald-100 text-emerald-700' : (item.qty > 0 ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700');
                    
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow p-5 flex flex-col justify-between";
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-semibold uppercase tracking-wider text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100 truncate max-w-[50%]">
                                    ${item.category}
                                </span>
                                <div class="flex gap-2">
                                    <button onclick="alert('Funcionalidade de Edição requer atualização no Backend (api/items.js)')" class="text-slate-300 hover:text-brand-600 transition-colors"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button onclick="alert('Funcionalidade de Exclusão requer atualização no Backend (api/items.js)')" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg mb-1 line-clamp-1">${item.name}</h3>
                            <p class="text-sm text-slate-500 font-mono mb-4"><i class="fa-solid fa-barcode mr-1"></i> ${item.code || 'S/N'}</p>
                        </div>
                        <div class="flex items-center justify-between mt-2 pt-4 border-t border-slate-100">
                            <span class="text-xs text-slate-400">ID: #${item.id.toString().slice(-4)}</span>
                            <span class="${qtyColor} px-3 py-1 rounded-full text-xs font-bold">Qtd: ${item.qty}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        // --- 3. LOGICA DO MODAL E SALVAMENTO ---
        
        function openModal() {
            document.getElementById('itemModal').classList.remove('hidden');
            // Limpa form
            document.getElementById('itemId').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemQty').value = '';
        }

        function closeModal() {
            document.getElementById('itemModal').classList.add('hidden');
        }

        function saveItem() {
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value;
            const qty = document.getElementById('itemQty').value;
            const category = document.getElementById('itemCategory').value;

            if (!name) { alert("Insira o nome."); return; }

            // Cria objeto
            const newItem = {
                id: Date.now().toString(), // Gera ID único baseado no tempo
                code: code || 'N/A',
                name: name,
                qty: qty || 0,
                category: category
            };

            // Fecha modal visualmente primeiro (UX)
            closeModal();
            
            // Envia para o Backend
            saveToBackend(newItem);
        }

        // --- 4. SCANNER (Câmera - Mantido) ---
        function startScanner() {
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.classList.remove('hidden');
            if (!html5QrcodeScanner) { html5QrcodeScanner = new Html5Qrcode("reader"); }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => { console.error(err); alert("Erro na câmera."); stopScanner(); });
        }

        function onScanSuccess(decodedText) {
            document.getElementById('itemCode').value = decodedText;
            stopScanner();
            const input = document.getElementById('itemCode');
            input.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-green-500'), 1000);
        }

        function onScanFailure(error) { }

        function stopScanner() {
            document.getElementById('scannerModal').classList.add('hidden');
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().catch(err => console.log(err));
            }
        }
    </script>
</body>
</html>
